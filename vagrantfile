# If not done already, install the Vagrant VMware Utility, then run vagrant plugin install vagrant-vmware-desktop to install the 
# plugin otherwise error will be given about no providers found

# Vagrantfile for Active Directory Lab - VMware Workstation (Isolated Environment)
Vagrant.configure("2") do |config|

  # ============================================================================
  # GLOBAL SETTINGS
  # ============================================================================
  
  # Prebuilt Windows Server 2019 DC from Vagrant Cloud
  config.vm.box = "dstoliker/winserver2019-dc"
  config.vm.box_version = "1.1.20250225155428"

  # WinRM for host-to-guest command execution (required for Windows guests)
  config.vm.communicator = "winrm"
  config.winrm.username = "vagrant"
  config.winrm.password = "vagrant"
  config.winrm.timeout = 300
  config.winrm.retry_limit = 20

  # Synced folder for dropping files from host to guest
  # Host folder: ./shared -> Guest folder: C:\vagrant_shared
  # Map share in workstation for this to work, will be enabled but nothing mapped
  config.vm.synced_folder "./shared", "/vagrant_shared", 
    create: true,
    type: "smb",
    smb_username: ENV['USERNAME'],
    smb_password: ENV['SMB_PASSWORD']

  # ============================================================================
  # DOMAIN CONTROLLER
  # ============================================================================
  config.vm.define "lab-dc-01", primary: true do |dc|
    dc.vm.hostname = "LAB-DC-01"

    # LAB NETWORK: 172.30.99.x (clearly distinct from typical home/work networks)
    # Host will be reachable at 172.30.99.1, VM at 172.30.99.10
    dc.vm.network "private_network", ip: "172.30.99.10"

    # -------------------------------------------------------------------------
    # VMWARE WORKSTATION PROVIDER
    # -------------------------------------------------------------------------
    dc.vm.provider "vmware_desktop" do |v|
      v.gui = true                                      # Show console window
      v.vmx["displayName"] = "AD-Lab-DC-01"             # VM name in VMware
      v.vmx["memsize"] = "8192"                         # 8GB RAM
      v.vmx["numvcpus"] = "8"                           # 8 vCPUs
      v.vmx["ethernet1.connectiontype"] = "hostonly"   # Isolated from internet
      v.whitelist_verified = true
    end

    # -------------------------------------------------------------------------
    # PROVISIONING (optional - uncomment to use Ansible)
    # -------------------------------------------------------------------------
    # dc.vm.provision "ansible" do |ansible|
    #   ansible.playbook = "ansible/site.yml"
    #   ansible.extra_vars = {
    #     ansible_user: "vagrant",
    #     ansible_password: "vagrant",
    #     ansible_connection: "winrm",
    #     ansible_winrm_transport: "ntlm"
    #   }
    # end

    dc.vm.provision "shell", inline: <<-SHELL
      Write-Host "=== AD Lab Domain Controller Ready ==="
      Write-Host "Network: 172.30.99.x (LAB)"
      Write-Host "Access via WinRM from host"
    SHELL
  end
end